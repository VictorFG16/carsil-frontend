<app-navbar></app-navbar>
<div class="container mt-4">
  <div class="titulo bg-primary text-white p-3 mb-4">
    <h2>Crear Orden de Producción</h2>
  </div>

  <form (ngSubmit)="onSubmit(productForm)" #productForm="ngForm" novalidate>
    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="description">Descripción</label>
          <input
            type="text"
            id="description"
            [(ngModel)]="product.description"
            name="descripcion"
            class="form-control"
          />
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="referencia">Referencia</label>
          <input
            type="number"
            id="referencia"
            [(ngModel)]="product.referencia"
            name="referencia"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.referencia"
            required
            numericOnly
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.referencia"
          >
            La referencia es requerida
          </div>
        </div>
      </div>
    </div>

    <!-- FECHAS -->
    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="fechaAsignada">Fecha Asignada</label>
          <input
            type="date"
            id="fechaAsignada"
            [(ngModel)]="product.fechaAsignada"
            name="fechaAsignada"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.fechaAsignada"
            required
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.fechaAsignada"
          >
            La fecha asignada es requerida
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="fechaEntrada">Fecha Entrada</label>
          <input
            type="date"
            id="fechaEntrada"
            [(ngModel)]="product.fechaEntrada"
            name="fechaEntrada"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.fechaEntrada"
            required
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.fechaEntrada"
          >
            La fecha de entrada es requerida
          </div>
        </div>
      </div>
    </div>

    <!-- CAMPOS DE TEXTO -->
    <div class="row">
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="marca">Marca</label>
          <select
            class="form-select"
            name="marca"
            [(ngModel)]="product.marca"
            required
            [class.is-invalid]="productForm.submitted && !product.marca"
          >
            <option [ngValue]="null" disabled selected>
              Seleccione una marca
            </option>
            <option *ngFor="let b of brands" [ngValue]="b.label">
              {{ b.label }}
            </option>
          </select>
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.marca"
          >
            La marca es requerida
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="op">OP</label>
          <input
            type="number"
            id="op"
            [(ngModel)]="product.op"
            name="op"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.op"
            required
            numericOnly
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.op"
          >
            El OP es requerido
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="camp">Campaña</label>
          <input
            type="number"
            id="camp"
            [(ngModel)]="product.camp"
            name="camp"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.camp"
            required
            numericOnly
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.camp"
          >
            La campaña es requerida
          </div>
        </div>
      </div>
    </div>

    <!-- TIPO, TALLAS Y PRECIO -->
    <div class="row">
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="tipo">Tipo</label>
          <input
            type="text"
            id="tipo"
            [(ngModel)]="product.tipo"
            name="tipo"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.tipo"
            required
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.tipo"
          >
            El tipo es requerido
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="talla">Talla</label>
          <button
            type="button"
            class="form-control"
            [ngClass]="{
              'btn-outline-secondary': !hasSizesSelected(),
              'btn-success': hasSizesSelected(),
              'is-invalid': productForm.submitted && !hasSizesSelected()
            }"
            (click)="openSizeModal()"
          >
            {{
              hasSizesSelected()
                ? "✓ Tallas seleccionadas"
                : "Seleccionar tallas"
            }}
          </button>
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !hasSizesSelected()"
          >
            La talla es requerida
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="price">Precio Unitario</label>
          <input
            type="number"
            id="price"
            [(ngModel)]="product.price"
            name="price"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.price"
            required
            min="0"
            placeholder="0"
            numericOnly
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.price"
          >
            El precio es requerido
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="team">Equipo</label>
          <button
            type="button"
            class="form-control"
            [ngClass]="{
              'btn-outline-secondary': !hasTeamSelected(),
              'btn-success': hasTeamSelected(),
              'is-invalid': productForm.submitted && !hasTeamSelected()
            }"
            (click)="openTeamModal()"
          >
            {{
              hasTeamSelected()
                ? "✓ Equipo: " + product.team?.name
                : "Seleccionar Equipo"
            }}
          </button>
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !hasTeamSelected()"
          >
            El equipo es requerido
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="sam">SAM</label>
          <input
            type="number"
            id="sam"
            [(ngModel)]="product.sam"
            name="sam"
            placeholder="0.00"
            numericOnly
            [allowDecimal]="true"
            class="form-control"
            [class.is-invalid]="
              productForm.submitted && (!product.sam || product.sam <= 0)
            "
            required
            min="0.01"
            step="0.01"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && (!product.sam || product.sam <= 0)"
          >
            El SAM es requerido y debe ser mayor a 0
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label for="quantity">Total</label>
            <input
              type="number"
              id="quantity"
              [(ngModel)]="product.quantity"
              name="quantity"
              class="form-control"
              [disabled]="true"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="buttons d-flex gap-2">
      <button type="submit" class="btn btn-primary">Agregar OP</button>
      <button
        type="button"
        class="btn btn-secondary"
        (click)="volverAlInventario()"
      >
        Cancelar
      </button>
    </div>
  </form>
</div>

<!-- MODAL DE MÓDULOS -->
<div
  class="modal"
  id="TeamModal"
  tabindex="-1"
  [ngClass]="{ 'show d-block': showTeamModal }"
  style="background-color: rgba(0, 0, 0, 0.5)"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Equipo</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeTeamModal()"
        ></button>
      </div>
      <div class="modal-body">
        <h6 class="text-center mb-3">Seleccionar Equipo</h6>
        <div class="list-group">
          <button
            type="button"
            class="list-group-item list-group-item-action"
            *ngFor="let mod of teams"
            (click)="selectTeam(mod)"
          >
            {{ mod.name }} - {{ mod.description }}
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeTeamModal()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Éxito al crear producto -->
<div class="modal fade" id="exitoModal" tabindex="-1" aria-labelledby="exitoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="exitoModalLabel">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
          </svg>
          ¡Éxito!
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#28a745" class="bi bi-check-circle mb-3" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
        </svg>
        <h5 class="mb-2">La orden de producción se creó exitosamente</h5>
        <p class="text-muted">La orden de producción ha sido agregada al listado.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE TALLAS -->
<div
  class="modal"
  id="sizeModal"
  tabindex="-1"
  [ngClass]="{ 'show d-block': showSizeModal }"
  style="background-color: rgba(0, 0, 0, 0.5)"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Tallas y Cantidades</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeSizeModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center mb-3">
          <button
            type="button"
            class="btn btn-outline-primary me-2"
            [class.active]="activeSizeSection === 'kids'"
            (click)="showKidsSizes()"
          >
            Tallas Niños
          </button>
          <button
            type="button"
            class="btn btn-outline-primary"
            [class.active]="activeSizeSection === 'adult'"
            (click)="showAdultSizes()"
          >
            Tallas Adultos
          </button>
        </div>

        <div *ngIf="activeSizeSection === 'kids'">
          <h6 class="text-center mb-3">Tallas de Niños</h6>
          <div
            *ngFor="let size of kidsSizes"
            class="mb-2 d-flex align-items-center"
          >
            <label
              [for]="'kids-size-' + size.name"
              class="me-2"
              style="width: 50px"
              >{{ size.name }}</label
            >
            <input
              [id]="'kids-size-' + size.name"
              type="number"
              placeholder="0"
              min="0"
              numericOnly
              [(ngModel)]="size.quantity"
              class="form-control"
              style="width: 100px"
            />
          </div>
        </div>

        <div *ngIf="activeSizeSection === 'adult'">
          <h6 class="text-center mb-3">Tallas de Adultos</h6>
          <div
            *ngFor="let size of adultSizes"
            class="mb-2 d-flex align-items-center"
          >
            <label
              [for]="'adult-size-' + size.name"
              class="me-2"
              style="width: 50px"
              >{{ size.name }}</label
            >
            <input
              [id]="'adult-size-' + size.name"
              type="number"
              numericOnly
              min="0"
              placeholder="0"
              [(ngModel)]="size.quantity"
              class="form-control"
              style="width: 100px"
              
            />
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="clearSizes()">
          Limpiar Tallas
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeSizeModal()"
        >
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="saveSizes()">
          Guardar
        </button>
      </div>
    </div>
  </div>
</div>
